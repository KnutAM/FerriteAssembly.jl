<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Plasticity · FerriteAssembly.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://KnutAM.github.io/FerriteAssembly.jl/tutorials/plasticity/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FerriteAssembly.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Learning by doing</span><ul><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox" checked/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../heat_equation/">Heat Equation</a></li><li class="is-active"><a class="tocitem" href>Plasticity</a><ul class="internal"><li><a class="tocitem" href="#Material-modeling"><span>Material modeling</span></a></li><li><a class="tocitem" href="#Standard-Ferrite.jl-setup"><span>Standard <code>Ferrite.jl</code> setup</span></a></li><li><a class="tocitem" href="#Setting-up-the-assembly"><span>Setting up the assembly</span></a></li><li><a class="tocitem" href="#Solving-the-problem"><span>Solving the problem</span></a></li><li><a class="tocitem" href="#Postprocessing"><span>Postprocessing</span></a></li></ul></li><li><a class="tocitem" href="../mixed_materials/">Multiple materials</a></li><li><a class="tocitem" href="../iga/">Isogeometric analysis with <code>IGA.jl</code></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox"/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">How-to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../howto/threaded_assembly/">Threaded assembly</a></li><li><a class="tocitem" href="../../howto/automatic_differentiation/">Automatic differentiation</a></li><li><a class="tocitem" href="../../howto/robin_bc/">Robin boundary conditions</a></li><li><a class="tocitem" href="../../howto/volume_integral/">Volume integration</a></li><li><a class="tocitem" href="../../howto/surface_integral/">Surface integration</a></li></ul></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../design/">Design</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">DomainBuffers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../DomainBuffers/Setup/">DomainBuffers</a></li><li><a class="tocitem" href="../../DomainBuffers/StateVariables/">State variables</a></li><li><a class="tocitem" href="../../DomainBuffers/ItemBuffer/">ItemBuffer</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Workers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Workers/Workers/">Workers</a></li><li><a class="tocitem" href="../../Workers/Assemblers/">Assemblers</a></li><li><a class="tocitem" href="../../Workers/Integrators/">Integrators</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Convenience</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Convenience/LoadHandler/">External loads</a></li><li><a class="tocitem" href="../../Convenience/MaterialModelsBase/">Mechanical materials</a></li><li><a class="tocitem" href="../../Convenience/ExampleElements/">Example elements</a></li></ul></li><li><a class="tocitem" href="../../Customization/">Customizations</a></li><li><a class="tocitem" href="../../internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Learning by doing</a></li><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Plasticity</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Plasticity</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/KnutAM/FerriteAssembly.jl/blob/main/docs/src/literate_tutorials/plasticity.jl#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Plasticity"><a class="docs-heading-anchor" href="#Plasticity">Plasticity</a><a id="Plasticity-1"></a><a class="docs-heading-anchor-permalink" href="#Plasticity" title="Permalink"></a></h1><p>This tutorial shows how to solve a plasticity problem by using the interface to <a href="https://github.com/KnutAM/MaterialModelsBase.jl"><code>MaterialModelsBase.jl</code></a> included in <code>FerriteAssembly.jl</code>. Specifically, FerriteAssembly comes with the <code>element_routine!</code> defined for any <code>MaterialModelsBase.AbstractMaterial</code>.</p><p>We adopt the material model as well as the simulation case from <code>Ferrite.jl</code>&#39;s <a href="https://ferrite-fem.github.io/Ferrite.jl/stable/examples/plasticity/">plasticity example</a></p><pre><code class="language-julia hljs">using Printf, LinearAlgebra
using Tensors, MaterialModelsBase, Ferrite, FerriteAssembly</code></pre><h2 id="Material-modeling"><a class="docs-heading-anchor" href="#Material-modeling">Material modeling</a><a id="Material-modeling-1"></a><a class="docs-heading-anchor-permalink" href="#Material-modeling" title="Permalink"></a></h2><p>We start by defining the J2PlasticityNew material model parameter struct, and an instance thereof</p><pre><code class="language-julia hljs">struct J2PlasticityNew{T} &lt;: AbstractMaterial
    G::T  # Shear modulus
    K::T  # Bulk modulus
    σ0::T # Initial yield limit
    H::T  # Hardening modulus
    D::SymmetricTensor{4, 3, T, 36} # Elastic stiffness tensor
end
function J2PlasticityNew(E, ν, σ₀, H)
    G = E / 2(1 + ν)
    K = E / 3(1 - 2ν)
    I2 = one(SymmetricTensor{2,3})
    I4 = one(SymmetricTensor{4,3})
    IxI = I2 ⊗ I2
    D = 2G*(I4 - IxI/3) + K*IxI
    return J2PlasticityNew(G, K, σ₀, H, D)
end
material = J2PlasticityNew(200.0e9, 0.3, 200.0e6, 10.0e9);</code></pre><p>Followed by the state variable struct along with its initial condition.</p><pre><code class="language-julia hljs">struct J2PlasticityState{T} &lt;: AbstractMaterialState
    ϵp::SymmetricTensor{2,3,T,6} # plastic strain
    κ::T                         # hardening stress
end;
function MaterialModelsBase.initial_material_state(::J2PlasticityNew)
    return J2PlasticityState(zero(SymmetricTensor{2,3}), 0.0)
end;</code></pre><p>And finally the actual <code>material_response</code> function, with a few helper functions</p><pre><code class="language-julia hljs">function vonmises(σ)
    σdev = dev(σ)
    return sqrt((3/2)*(σdev⊡σdev))
end
function calculate_plastic_stress(ϵ, m, state) # When plastic
    σ_trial = m.D ⊡ (ϵ - state.ϵp)
    σeff_trial = vonmises(σ_trial)
    σdev_trial = dev(σ_trial)
    Φ_trial = σeff_trial - (m.σ0 + state.κ)
    μ = Φ_trial / (m.H + 3m.G)       # plastic multiplier
    σdev = (1 - 3m.G * μ / σeff_trial) * σdev_trial
    return σdev + vol(σ_trial)   # updated stress
end
function MaterialModelsBase.material_response(
    material::J2PlasticityNew, ϵ::SymmetricTensor{2,3}, state::J2PlasticityState,
    Δt, cache=get_cache(material), args...; kwargs...)

    σ_trial = material.D ⊡ (ϵ - state.ϵp) # trial-stress
    Φ_trial = vonmises(σ_trial) - (material.σ0 + state.κ)
    if Φ_trial &lt; 0.0 # elastic loading
        return σ_trial, material.D, J2PlasticityState(state.ϵp, state.κ)
    else # plastic loading
        dσdϵ, σ = gradient(ϵ_ -&gt; calculate_plastic_stress(ϵ_, material, state), ϵ, :all)

        μ =  Φ_trial / (material.H + 3*material.G)   # plastic multiplier
        κ = state.κ + μ*material.H
        σeff = material.σ0 + κ

        return σ, dσdϵ, J2PlasticityState(state.ϵp + (μ*3/(2*σeff))*dev(σ), κ)
    end
end;</code></pre><h2 id="Standard-Ferrite.jl-setup"><a class="docs-heading-anchor" href="#Standard-Ferrite.jl-setup">Standard <code>Ferrite.jl</code> setup</a><a id="Standard-Ferrite.jl-setup-1"></a><a class="docs-heading-anchor-permalink" href="#Standard-Ferrite.jl-setup" title="Permalink"></a></h2><p>With all required functions defined, we can now setup and assemble the finite element problem using only Ferrite functionality</p><pre><code class="language-julia hljs">grid = generate_grid(Tetrahedron, (20,2,4), zero(Vec{3}), Vec((10.0,1.0,1.0)))

ip = Lagrange{3, RefTetrahedron, 1}()
dh = DofHandler(grid); add!(dh, :u, 3, ip); close!(dh)

ch = ConstraintHandler(dh)
add!(ch, Dirichlet(:u, getfaceset(grid, &quot;left&quot;), Returns(zero(Vec{3}))))
close!(ch)

cellvalues = CellVectorValues(QuadratureRule{3,RefTetrahedron}(2), ip)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">CellVectorValues{3, Float64, RefTetrahedron, 9} with 12 shape functions and 4 quadrature points</code></pre><h2 id="Setting-up-the-assembly"><a class="docs-heading-anchor" href="#Setting-up-the-assembly">Setting up the assembly</a><a id="Setting-up-the-assembly-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-assembly" title="Permalink"></a></h2><p>Using the <code>setup_domainbuffer</code> function,</p><pre><code class="language-julia hljs">buffer = setup_domainbuffer(DomainSpec(dh, material, cellvalues));</code></pre><p>we setup the <code>buffer</code>, old state variables, and new state variables. The state variables are created via the <a href="../../Convenience/MaterialModelsBase/#FerriteAssembly.create_cell_state-Tuple{MaterialModelsBase.AbstractMaterial, CellVectorValues, Vararg{Any}}"><code>create_cell_state</code></a> function that is already defined for <code>MaterialModelsBase.AbstractMaterial</code>, since we overloaded <code>MaterialModelsBase.initial_material_state</code> above.</p><p>So far, we haven&#39;t included any loading, and following the original example, we would add loading as a Neumann boundary condition on the right side. For this, we&#39;ll use FerriteAssembly&#39;s convenience LoadHandler</p><pre><code class="language-julia hljs">f = zeros(ndofs(dh)) # Pre-allocate external force vector to only apply external load once per time step.
traction_function(t) = 1e7*t
lh = LoadHandler(dh)
qr_order = 3
add!(lh, Neumann(:u, qr_order, getfaceset(grid, &quot;right&quot;), (x,t,n)-&gt;Vec((0.0, 0.0, traction_function(t)))))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">FerriteAssembly.DomainBuffer{FaceIndex, FerriteAssembly.FaceBuffer{Float64, Vector{Vec{3, Float64}}, FaceVectorValues{3, Float64, RefTetrahedron, 9}, NamedTuple{(:u,), Tuple{UnitRange{Int64}}}, FerriteAssembly.NeumannMaterial{Main.var&quot;#4#5&quot;}, Nothing, Nothing}, Nothing, FerriteAssembly.SubDofHandler{DofHandler{3, Float64, Grid{3, Tetrahedron, Float64}}, Nothing}}(FaceIndex[FaceIndex((118, 1)), FaceIndex((120, 1)), FaceIndex((238, 1)), FaceIndex((240, 1)), FaceIndex((358, 1)), FaceIndex((360, 1)), FaceIndex((478, 1)), FaceIndex((480, 1)), FaceIndex((598, 1)), FaceIndex((600, 1)), FaceIndex((718, 1)), FaceIndex((720, 1)), FaceIndex((838, 1)), FaceIndex((840, 1)), FaceIndex((958, 1)), FaceIndex((960, 1))], FerriteAssembly.FaceBuffer{Float64, Vector{Vec{3, Float64}}, FaceVectorValues{3, Float64, RefTetrahedron, 9}, NamedTuple{(:u,), Tuple{UnitRange{Int64}}}, FerriteAssembly.NeumannMaterial{Main.var&quot;#4#5&quot;}, Nothing, Nothing}([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], Vec{3, Float64}[[0.0, 0.0, 0.0], [0.5, 0.0, 0.0], [0.0, 0.5, 0.0], [0.0, 0.5, 0.25]], FaceVectorValues{3, Float64, RefTetrahedron, 9}([[0.3333333333333401, 0.0, 0.0] [0.6000000000000001, 0.0, 0.0] [0.20000000000000007, 0.0, 0.0] [0.2, 0.0, 0.0]; [0.0, 0.3333333333333401, 0.0] [0.0, 0.6000000000000001, 0.0] [0.0, 0.20000000000000007, 0.0] [0.0, 0.2, 0.0]; … ; [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0]; [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0];;; [0.3333333333333401, 0.0, 0.0] [0.6000000000000001, 0.0, 0.0] [0.20000000000000007, 0.0, 0.0] [0.2, 0.0, 0.0]; [0.0, 0.3333333333333401, 0.0] [0.0, 0.6000000000000001, 0.0] [0.0, 0.20000000000000007, 0.0] [0.0, 0.2, 0.0]; … ; [0.0, 0.33333333333333, 0.0] [0.0, 0.2, 0.0] [0.0, 0.6, 0.0] [0.0, 0.2, 0.0]; [0.0, 0.0, 0.33333333333333] [0.0, 0.0, 0.2] [0.0, 0.0, 0.6] [0.0, 0.0, 0.2];;; [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0]; [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0] [0.0, 0.0, 0.0]; … ; [0.0, 0.3333333333333401, 0.0] [0.0, 0.6000000000000001, 0.0] [0.0, 0.20000000000000007, 0.0] [0.0, 0.2, 0.0]; [0.0, 0.0, 0.3333333333333401] [0.0, 0.0, 0.6000000000000001] [0.0, 0.0, 0.20000000000000007] [0.0, 0.0, 0.2];;; [0.3333333333333401, 0.0, 0.0] [0.6000000000000001, 0.0, 0.0] [0.20000000000000007, 0.0, 0.0] [0.2, 0.0, 0.0]; [0.0, 0.3333333333333401, 0.0] [0.0, 0.6000000000000001, 0.0] [0.0, 0.20000000000000007, 0.0] [0.0, 0.2, 0.0]; … ; [0.0, 0.33333333333333, 0.0] [0.0, 0.2, 0.0] [0.0, 0.6, 0.0] [0.0, 0.2, 0.0]; [0.0, 0.0, 0.33333333333333] [0.0, 0.0, 0.2] [0.0, 0.0, 0.6] [0.0, 0.0, 0.2]], [[NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; … ; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN];;; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; … ; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN];;; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; … ; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN];;; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; … ; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]; [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN] [NaN NaN NaN; NaN NaN NaN; NaN NaN NaN]], [[-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0]; … ; [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0];;; [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0]; … ; [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0];;; [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0]; … ; [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0];;; [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0] [-1.0 -1.0 -1.0; 0.0 0.0 0.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; -1.0 -1.0 -1.0; 0.0 0.0 0.0]; … ; [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0] [0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 0.0 0.0]; [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0] [0.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0]], [NaN NaN NaN NaN; NaN NaN NaN NaN; NaN NaN NaN NaN; NaN NaN NaN NaN], Vec{3, Float64}[[0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0], [0.0, 0.0, 0.0]], [0.3333333333333401 0.6000000000000001 0.20000000000000007 0.2; 0.33333333333333 0.2 0.2 0.6; 0.33333333333333 0.2 0.6 0.2; 0.0 0.0 0.0 0.0;;; 0.3333333333333401 0.6000000000000001 0.20000000000000007 0.2; 0.33333333333333 0.2 0.2 0.6; 0.0 0.0 0.0 0.0; 0.33333333333333 0.2 0.6 0.2;;; 0.0 0.0 0.0 0.0; 0.33333333333333 0.2 0.2 0.6; 0.33333333333333 0.2 0.6 0.2; 0.3333333333333401 0.6000000000000001 0.20000000000000007 0.2;;; 0.3333333333333401 0.6000000000000001 0.20000000000000007 0.2; 0.0 0.0 0.0 0.0; 0.33333333333333 0.2 0.2 0.6; 0.33333333333333 0.2 0.6 0.2], [[-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0]; [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0]; [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0]; [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0];;; [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0]; [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0]; [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0]; [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0];;; [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0]; [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0]; [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0]; [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0];;; [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0] [-1.0, -1.0, -1.0]; [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0] [1.0, 0.0, 0.0]; [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0] [0.0, 1.0, 0.0]; [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0] [0.0, 0.0, 1.0]], QuadratureRule{2, RefTetrahedron, Float64}([-0.28125, 0.260416666666665, 0.260416666666665, 0.260416666666665], Vec{2, Float64}[[0.33333333333333, 0.33333333333333], [0.2, 0.2], [0.2, 0.6], [0.6, 0.2]]), Ferrite.ScalarWrapper{Int64}(0), Lagrange{3, RefTetrahedron, 1}(), Lagrange{3, RefTetrahedron, 1}()), NaN, -1, (u = 1:12,), FerriteAssembly.NeumannMaterial{Main.var&quot;#4#5&quot;}(Main.var&quot;#4#5&quot;(), 1:12), nothing, nothing), Dict{Int64, Nothing}(), Dict{Int64, Nothing}(), FerriteAssembly.SubDofHandler{DofHandler{3, Float64, Grid{3, Tetrahedron, Float64}}, Nothing}(DofHandler{3, Float64, Grid{3, Tetrahedron, Float64}}([:u], [3], Interpolation[Lagrange{3, RefTetrahedron, 1}()], Ferrite.BCValues{Float64}[Ferrite.BCValues{Float64}([1.0 0.0 0.0; 0.0 0.0 1.0; 0.0 1.0 0.0; 0.0 0.0 0.0;;; 1.0 0.0 0.0; 0.0 1.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0;;; 0.0 0.0 0.0; 1.0 0.0 0.0; 0.0 1.0 0.0; 0.0 0.0 1.0;;; 1.0 0.0 0.0; 0.0 0.0 0.0; 0.0 0.0 1.0; 0.0 1.0 0.0], Ferrite.ScalarWrapper{Int64}(0))], [1, 2, 3, 4, 5, 6, 7, 8, 9, 10  …  690, 877, 878, 879, 943, 944, 945, 940, 941, 942], [1, 13, 25, 37, 49, 61, 73, 85, 97, 109  …  11413, 11425, 11437, 11449, 11461, 11473, 11485, 11497, 11509, 11521], Ferrite.ScalarWrapper{Bool}(true), Grid{3, Tetrahedron, Float64}(Tetrahedron[Tetrahedron((1, 2, 22, 85)), Tetrahedron((1, 64, 2, 85)), Tetrahedron((2, 23, 22, 85)), Tetrahedron((2, 86, 23, 85)), Tetrahedron((2, 64, 65, 85)), Tetrahedron((2, 65, 86, 85)), Tetrahedron((2, 3, 23, 86)), Tetrahedron((2, 65, 3, 86)), Tetrahedron((3, 24, 23, 86)), Tetrahedron((3, 87, 24, 86))  …  Tetrahedron((230, 251, 250, 313)), Tetrahedron((230, 314, 251, 313)), Tetrahedron((230, 292, 293, 313)), Tetrahedron((230, 293, 314, 313)), Tetrahedron((230, 231, 251, 314)), Tetrahedron((230, 293, 231, 314)), Tetrahedron((231, 252, 251, 314)), Tetrahedron((231, 315, 252, 314)), Tetrahedron((231, 293, 294, 314)), Tetrahedron((231, 294, 315, 314))], Node{3, Float64}[Node{3, Float64}([0.0, 0.0, 0.0]), Node{3, Float64}([0.5, 0.0, 0.0]), Node{3, Float64}([1.0, 0.0, 0.0]), Node{3, Float64}([1.5, 0.0, 0.0]), Node{3, Float64}([2.0, 0.0, 0.0]), Node{3, Float64}([2.5, 0.0, 0.0]), Node{3, Float64}([3.0, 0.0, 0.0]), Node{3, Float64}([3.5, 0.0, 0.0]), Node{3, Float64}([4.0, 0.0, 0.0]), Node{3, Float64}([4.5, 0.0, 0.0])  …  Node{3, Float64}([5.5, 1.0, 1.0]), Node{3, Float64}([6.0, 1.0, 1.0]), Node{3, Float64}([6.5, 1.0, 1.0]), Node{3, Float64}([7.0, 1.0, 1.0]), Node{3, Float64}([7.5, 1.0, 1.0]), Node{3, Float64}([8.0, 1.0, 1.0]), Node{3, Float64}([8.5, 1.0, 1.0]), Node{3, Float64}([9.0, 1.0, 1.0]), Node{3, Float64}([9.5, 1.0, 1.0]), Node{3, Float64}([10.0, 1.0, 1.0])], Dict{String, Set{Int64}}(), Dict{String, Set{Int64}}(), Dict{String, Set{FaceIndex}}(&quot;left&quot; =&gt; Set([FaceIndex((601, 4)), FaceIndex((122, 2)), FaceIndex((2, 2)), FaceIndex((842, 2)), FaceIndex((1, 4)), FaceIndex((481, 4)), FaceIndex((362, 2)), FaceIndex((121, 4)), FaceIndex((242, 2)), FaceIndex((482, 2)), FaceIndex((241, 4)), FaceIndex((722, 2)), FaceIndex((602, 2)), FaceIndex((361, 4)), FaceIndex((841, 4)), FaceIndex((721, 4))]), &quot;bottom&quot; =&gt; Set([FaceIndex((85, 1)), FaceIndex((93, 1)), FaceIndex((127, 1)), FaceIndex((115, 1)), FaceIndex((175, 1)), FaceIndex((235, 1)), FaceIndex((21, 1)), FaceIndex((1, 1)), FaceIndex((57, 1)), FaceIndex((63, 1))  …  FaceIndex((159, 1)), FaceIndex((97, 1)), FaceIndex((205, 1)), FaceIndex((193, 1)), FaceIndex((153, 1)), FaceIndex((231, 1)), FaceIndex((9, 1)), FaceIndex((81, 1)), FaceIndex((171, 1)), FaceIndex((169, 1))]), &quot;right&quot; =&gt; Set([FaceIndex((238, 1)), FaceIndex((478, 1)), FaceIndex((718, 1)), FaceIndex((120, 1)), FaceIndex((958, 1)), FaceIndex((840, 1)), FaceIndex((358, 1)), FaceIndex((838, 1)), FaceIndex((720, 1)), FaceIndex((118, 1)), FaceIndex((960, 1)), FaceIndex((480, 1)), FaceIndex((240, 1)), FaceIndex((600, 1)), FaceIndex((598, 1)), FaceIndex((360, 1))]), &quot;back&quot; =&gt; Set([FaceIndex((933, 3)), FaceIndex((910, 3)), FaceIndex((454, 3)), FaceIndex((459, 3)), FaceIndex((195, 3)), FaceIndex((921, 3)), FaceIndex((375, 3)), FaceIndex((429, 3)), FaceIndex((190, 3)), FaceIndex((153, 3))  …  FaceIndex((226, 3)), FaceIndex((922, 3)), FaceIndex((142, 3)), FaceIndex((621, 3)), FaceIndex((958, 3)), FaceIndex((387, 3)), FaceIndex((711, 3)), FaceIndex((849, 3)), FaceIndex((886, 3)), FaceIndex((405, 3))]), &quot;top&quot; =&gt; Set([FaceIndex((942, 3)), FaceIndex((947, 3)), FaceIndex((852, 3)), FaceIndex((804, 3)), FaceIndex((894, 3)), FaceIndex((941, 3)), FaceIndex((917, 3)), FaceIndex((791, 3)), FaceIndex((959, 3)), FaceIndex((744, 3))  …  FaceIndex((834, 3)), FaceIndex((822, 3)), FaceIndex((930, 3)), FaceIndex((948, 3)), FaceIndex((810, 3)), FaceIndex((875, 3)), FaceIndex((756, 3)), FaceIndex((792, 3)), FaceIndex((767, 3)), FaceIndex((893, 3))]), &quot;front&quot; =&gt; Set([FaceIndex((68, 1)), FaceIndex((803, 1)), FaceIndex((278, 1)), FaceIndex((530, 1)), FaceIndex((764, 1)), FaceIndex((767, 1)), FaceIndex((524, 1)), FaceIndex((548, 1)), FaceIndex((569, 1)), FaceIndex((482, 1))  …  FaceIndex((827, 1)), FaceIndex((80, 1)), FaceIndex((806, 1)), FaceIndex((731, 1)), FaceIndex((812, 1)), FaceIndex((62, 1)), FaceIndex((791, 1)), FaceIndex((338, 1)), FaceIndex((506, 1)), FaceIndex((119, 1))])), Dict{String, Set{EdgeIndex}}(), Dict{String, Set{VertexIndex}}(), sparse([1, 4, 1, 2, 1, 1, 1, 1, 1, 1  …  3, 3, 3, 3, 3, 1, 3, 3, 1, 3], [1, 1, 2, 2, 3, 5, 7, 8, 9, 11, 13, 14, 15, 17, 19, 20, 21, 23, 25, 26, 27, 29, 31, 32, 33, 35, 37, 38, 39, 41, 43, 44, 45, 47, 49, 50, 51, 53, 55, 56, 57, 59, 61, 62, 63, 65, 67, 68, 69, 71, 73, 74, 75, 77, 79, 80, 81, 83, 85, 86, 87, 89, 91, 92, 93, 95, 97, 98, 99, 101, 103, 104, 105, 107, 109, 110, 111, 113, 115, 116, 117, 118, 119, 120, 121, 121, 122, 123, 123, 124, 127, 129, 129, 130, 133, 135, 135, 136, 139, 141, 141, 142, 145, 147, 147, 148, 151, 153, 153, 154, 157, 159, 159, 160, 163, 165, 165, 166, 169, 171, 171, 172, 175, 177, 177, 178, 181, 183, 183, 184, 187, 189, 189, 190, 193, 195, 195, 196, 199, 201, 201, 202, 205, 207, 207, 208, 211, 213, 213, 214, 217, 219, 219, 220, 223, 225, 225, 226, 229, 231, 231, 232, 235, 237, 237, 238, 238, 240, 241, 242, 242, 245, 248, 251, 254, 257, 260, 263, 266, 269, 272, 275, 278, 281, 284, 287, 290, 293, 296, 299, 302, 305, 308, 311, 314, 317, 320, 323, 326, 329, 332, 335, 338, 341, 344, 347, 350, 353, 356, 358, 359, 360, 361, 362, 363, 364, 369, 370, 375, 376, 381, 382, 387, 388, 393, 394, 399, 400, 405, 406, 411, 412, 417, 418, 423, 424, 429, 430, 435, 436, 441, 442, 447, 448, 453, 454, 459, 460, 465, 466, 471, 472, 477, 478, 478, 480, 481, 482, 482, 485, 488, 491, 494, 497, 500, 503, 506, 509, 512, 515, 518, 521, 524, 527, 530, 533, 536, 539, 542, 545, 548, 551, 554, 557, 560, 563, 566, 569, 572, 575, 578, 581, 584, 587, 590, 593, 596, 598, 599, 600, 601, 602, 603, 604, 609, 610, 615, 616, 621, 622, 627, 628, 633, 634, 639, 640, 645, 646, 651, 652, 657, 658, 663, 664, 669, 670, 675, 676, 681, 682, 687, 688, 693, 694, 699, 700, 705, 706, 711, 712, 717, 718, 718, 720, 721, 722, 722, 725, 725, 726, 728, 731, 731, 732, 734, 737, 737, 738, 740, 743, 743, 744, 746, 749, 749, 750, 752, 755, 755, 756, 758, 761, 761, 762, 764, 767, 767, 768, 770, 773, 773, 774, 776, 779, 779, 780, 782, 785, 785, 786, 788, 791, 791, 792, 794, 797, 797, 798, 800, 803, 803, 804, 806, 809, 809, 810, 812, 815, 815, 816, 818, 821, 821, 822, 824, 827, 827, 828, 830, 833, 833, 834, 836, 838, 839, 839, 840, 840, 841, 842, 843, 844, 845, 846, 849, 850, 851, 852, 855, 856, 857, 858, 861, 862, 863, 864, 867, 868, 869, 870, 873, 874, 875, 876, 879, 880, 881, 882, 885, 886, 887, 888, 891, 892, 893, 894, 897, 898, 899, 900, 903, 904, 905, 906, 909, 910, 911, 912, 915, 916, 917, 918, 921, 922, 923, 924, 927, 928, 929, 930, 933, 934, 935, 936, 939, 940, 941, 942, 945, 946, 947, 948, 951, 952, 953, 954, 957, 958, 958, 959, 960, 960], Bool[1, 1, 1, 1, 1, 1, 1, 1, 1, 1  …  1, 1, 1, 1, 1, 1, 1, 1, 1, 1], 4, 960)), Ferrite.ScalarWrapper{Int64}(945)), nothing))</code></pre><h2 id="Solving-the-problem"><a class="docs-heading-anchor" href="#Solving-the-problem">Solving the problem</a><a id="Solving-the-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Solving-the-problem" title="Permalink"></a></h2><p>We first define how to step in time, and following the original example this would be</p><pre><code class="language-julia hljs">time_history = collect(range(0.5, 1.0, 10))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10-element Vector{Float64}:
 0.5
 0.5555555555555556
 0.6111111111111112
 0.6666666666666666
 0.7222222222222222
 0.7777777777777778
 0.8333333333333334
 0.8888888888888888
 0.9444444444444444
 1.0</code></pre><p>We can now solve the problem using Newton iterations, for each time step.</p><pre><code class="language-julia hljs">function solve_problem(buffer, time_history, dh, ch, lh)
    K = create_sparsity_pattern(dh)
    r = zeros(ndofs(dh))
    a = zeros(ndofs(dh))
    t_old = 0.0
    u_max = [0.0]   # To save for plotting
    for t in time_history
        newton_itr = -1
        print(&quot;\n t = $t:\n&quot;)
        # Set the time increment passed to the material model
        # Not actually needed for this material, but in general it should be set
        set_time_increment!(buffer, t - t_old)

        # Update and apply Dirichlet boundary conditions
        update!(ch, t)   # Update the constraint handler and
        apply!(a, ch)    # set the prescribed values in the solution vector

        # Update and apply Neumann boundary conditions
        fill!(f, 0)      # Reset the external load
        apply!(f, lh, t) # Apply the Neumann boundary conditions
        while true; newton_itr += 1
            newton_itr &gt; 8 &amp;&amp; error(&quot;Reached maximum Newton iterations, aborting&quot;)
            # Assemble the contributions
            assembler = start_assemble(K, r) # K and r are zeroed by this call.
            work!(assembler, buffer; a=a)
            r .-= f                 # Subtract external forces
            apply_zero!(K, r, ch)   # Apply Dirichlet boundary conditions

            norm_r = norm(r) # Constrained dofs in r where zeroed by apply_zero!
            print(&quot;Iteration: $newton_itr \tresidual: $(@sprintf(&quot;%.8f&quot;, norm_r))\n&quot;)
            norm_r &lt; 1.0 &amp;&amp; break # Tolerance 1 N

            Δa = -Symmetric(K) \ r  # Do one Newton update
            apply_zero!(Δa, ch)     # Ensure exact BC (See Ferrite&#39;s doc)
            a .+= Δa                # Update the displacements
        end

        # Update the old states with the converged values for next timestep
        update_states!(buffer)  # I.e states_old = states
        t_old = t   # Update the old time (to calculate Δt)
        push!(u_max, maximum(abs, a)) # Save the maximum displacement in current timestep
    end
    return a, u_max
end
a, u_max = solve_problem(buffer, time_history, dh, ch, lh)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">([0.0, 0.0, 0.0, 0.0010757421758529353, 0.00044662882232892687, 0.0009462899807578673, 0.0, 0.0, 0.0, 0.0  …  0.20330178174393715, -0.015027851102484084, -0.02754664968910463, 0.22026817958010386, -0.015093028547484223, -0.02957530183861363, 0.23733419679661258, -0.015113931302118092, -0.031603088153305696, 0.2544526450592654], [0.0, 0.06817024083483487, 0.07622793246254046, 0.08587448720370122, 0.0968644764210487, 0.10978786077998488, 0.12672590626179572, 0.15061988797949172, 0.18072577381519306, 0.21548754966506173, 0.2544526450592654])</code></pre><h2 id="Postprocessing"><a class="docs-heading-anchor" href="#Postprocessing">Postprocessing</a><a id="Postprocessing-1"></a><a class="docs-heading-anchor-permalink" href="#Postprocessing" title="Permalink"></a></h2><p>As in the Ferrite example, we would like to plot the traction versus the maximum displacements, and export the final displacement field, von Mises stress, and hardening stress. See Ferrite&#39;s example for the plotting.</p><pre><code class="language-julia hljs">traction = vcat(0.0, traction_function.(time_history))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">11-element Vector{Float64}:
 0.0
 5.0e6
 5.555555555555556e6
 6.111111111111112e6
 6.666666666666666e6
 7.222222222222222e6
 7.777777777777778e6
 8.333333333333334e6
 8.888888888888888e6
 9.444444444444444e6
 1.0e7</code></pre><p>Instead of using the average of the integration point values, as in Ferrite, we&#39;ll perform the volume averaging (which for 2nd order integration is equivalent), by using the Integrator to save values for each cell</p><pre><code class="language-julia hljs">struct PlasticIntegrator{T}
    σvm::Vector{T}
    κ::Vector{T}
end
PlasticIntegrator(ncells::Int) = PlasticIntegrator(fill(NaN, ncells), fill(NaN, ncells))
intval = PlasticIntegrator(getncells(grid))
integrator = Integrator(intval)
function FerriteAssembly.integrate_cell!(intval::PlasticIntegrator, states, ae, m::J2PlasticityNew, cv, buffer)
    cellnr = cellid(buffer)
    V = σvm = κ = 0.0
    for q_point in 1:getnquadpoints(cv)
        state = states[q_point]
        ϵ = function_symmetric_gradient(cv, q_point, ae)
        σ = m.D⊡(ϵ - state.ϵp)
        dΩ = getdetJdV(cv, q_point)
        V += dΩ
        σvm += vonmises(σ)*dΩ
        κ += state.κ*dΩ
    end
    intval.σvm[cellnr] = σvm/V
    intval.κ[cellnr] = κ/V
end

work!(integrator, buffer; a=a)

vtk_grid(&quot;plasticity&quot;, dh) do vtkfile
    vtk_point_data(vtkfile, dh, a) # displacement field
    vtk_cell_data(vtkfile,  intval.σvm, &quot;von Mises [Pa]&quot;)
    vtk_cell_data(vtkfile, intval.κ, &quot;Drag stress [Pa]&quot;)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1-element Vector{String}:
 &quot;plasticity.vtu&quot;</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../heat_equation/">« Heat Equation</a><a class="docs-footer-nextpage" href="../mixed_materials/">Multiple materials »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Saturday 9 September 2023 16:08">Saturday 9 September 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
