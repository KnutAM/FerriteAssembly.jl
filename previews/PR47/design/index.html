<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Design · FerriteAssembly.jl</title><meta name="title" content="Design · FerriteAssembly.jl"/><meta property="og:title" content="Design · FerriteAssembly.jl"/><meta property="twitter:title" content="Design · FerriteAssembly.jl"/><meta name="description" content="Documentation for FerriteAssembly.jl."/><meta property="og:description" content="Documentation for FerriteAssembly.jl."/><meta property="twitter:description" content="Documentation for FerriteAssembly.jl."/><meta property="og:url" content="https://KnutAM.github.io/FerriteAssembly.jl/design/"/><meta property="twitter:url" content="https://KnutAM.github.io/FerriteAssembly.jl/design/"/><link rel="canonical" href="https://KnutAM.github.io/FerriteAssembly.jl/design/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FerriteAssembly.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">Learning by doing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tutorials/heat_equation/">Heat Equation</a></li><li><a class="tocitem" href="../tutorials/viscoelasticity/">Viscoelasticity with state variables</a></li><li><a class="tocitem" href="../tutorials/incompressible_elasticity/">Multiple fields</a></li><li><a class="tocitem" href="../tutorials/mixed_materials/">Multiple materials</a></li><li><a class="tocitem" href="../tutorials/iga/">Using <code>IGA.jl</code></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-2-2" type="checkbox"/><label class="tocitem" for="menuitem-2-2"><span class="docs-label">How-to</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../howto/threaded_assembly/">Threaded assembly</a></li><li><a class="tocitem" href="../howto/automatic_differentiation/">Automatic differentiation</a></li><li><a class="tocitem" href="../howto/local_constraints/">Local constraint application</a></li><li><a class="tocitem" href="../howto/robin_bc/">Robin boundary conditions</a></li><li><a class="tocitem" href="../howto/volume_integral/">Volume integration</a></li><li><a class="tocitem" href="../howto/surface_integral/">Surface integration</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Reference</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Design</a><ul class="internal"><li><a class="tocitem" href="#Worker"><span>Worker</span></a></li><li><a class="tocitem" href="#Domain-buffer"><span>Domain buffer</span></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">DomainBuffers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../DomainBuffers/Setup/">DomainBuffers</a></li><li><a class="tocitem" href="../DomainBuffers/StateVariables/">State variables</a></li><li><a class="tocitem" href="../DomainBuffers/ItemBuffer/">ItemBuffer</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Workers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Workers/Workers/">Workers</a></li><li><a class="tocitem" href="../Workers/Assemblers/">Assemblers</a></li><li><a class="tocitem" href="../Workers/Integrators/">Integrators</a></li><li><a class="tocitem" href="../Workers/QuadPointEvaluator/">Quadrature point eval</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Convenience</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../Convenience/LoadHandler/">External loads</a></li><li><a class="tocitem" href="../Convenience/MaterialModelsBase/">Mechanical materials</a></li><li><a class="tocitem" href="../Convenience/ExampleElements/">Example elements</a></li></ul></li><li><a class="tocitem" href="../Customization/">Customizations</a></li><li><a class="tocitem" href="../internals/">Internals</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Reference</a></li><li class="is-active"><a href>Design</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Design</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/KnutAM/FerriteAssembly.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/KnutAM/FerriteAssembly.jl/blob/main/docs/src/design.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Package-design"><a class="docs-heading-anchor" href="#Package-design">Package design</a><a id="Package-design-1"></a><a class="docs-heading-anchor-permalink" href="#Package-design" title="Permalink"></a></h1><p>At the top level, the user of <code>FerriteAssembly</code> needs to interact with two main types of objects, a <em>domain buffer</em> (or a <code>Dict</code> of multiple domain buffers) and a <em>worker</em> (for example an assembler). </p><h2 id="Worker"><a class="docs-heading-anchor" href="#Worker">Worker</a><a id="Worker-1"></a><a class="docs-heading-anchor-permalink" href="#Worker" title="Permalink"></a></h2><p>The worker is the simplest object, and determines what is done for each item in the domain(s).</p><h2 id="Domain-buffer"><a class="docs-heading-anchor" href="#Domain-buffer">Domain buffer</a><a id="Domain-buffer-1"></a><a class="docs-heading-anchor-permalink" href="#Domain-buffer" title="Permalink"></a></h2><p>Two domain buffer types are implemented, a regular and a threaded version. To understand the structure, it sufficies to to understand the regular buffer. The threaded version just contains additional values to have per-task buffers etc.  The key fields of the <code>DomainBuffer</code> type are (1) a <code>set</code> of items to iterate over (for example a vector of <code>Int</code> for a list of cells or a vector of <code>FacetIndex</code> for a list of facets) and an <code>itembuffer</code> (e.g., <code>CellBuffer</code> or <code>FacetBuffer</code>) containing the data required to do something for each entity. </p><h3 id="ItemBuffer"><a class="docs-heading-anchor" href="#ItemBuffer">ItemBuffer</a><a id="ItemBuffer-1"></a><a class="docs-heading-anchor-permalink" href="#ItemBuffer" title="Permalink"></a></h3><p>The most important fields in an item buffer are the user-defined <code>material</code> and the <code>FEValues</code> (e.g. <code>CellValues</code> or <code>FacetValues</code>). </p><h3 id="Requirements-for-being-a-domain"><a class="docs-heading-anchor" href="#Requirements-for-being-a-domain">Requirements for being a domain</a><a id="Requirements-for-being-a-domain-1"></a><a class="docs-heading-anchor-permalink" href="#Requirements-for-being-a-domain" title="Permalink"></a></h3><p>In addition to having the same <code>FEValues</code> and <code>material</code>,  the items in a domain must also share the same <code>SubDofHandler</code>.  However, multiple domains can share the same <code>SubDofHandler</code>.</p><h3 id="Setting-up-one-domain"><a class="docs-heading-anchor" href="#Setting-up-one-domain">Setting up one domain</a><a id="Setting-up-one-domain-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-one-domain" title="Permalink"></a></h3><p>Each domain is described by a <code>DomainSpec</code>. Based on a <code>DomainSpec</code>, we call  the function <code>setup_domainbuffer</code> to create a <code>DomainBuffer</code>. The motivation  for this two-stage process, is to separate the information given and to simplify  setting up multiple domains. Depending on the options given to <code>setup_domainbuffer</code>, different buffers can be returned, such as <code>ThreadedDomainBuffer</code> or a domain buffer with a special <code>AutoDiffCellBuffer</code> to speed up automatic differentiation. </p><h3 id="Multiple-domains"><a class="docs-heading-anchor" href="#Multiple-domains">Multiple domains</a><a id="Multiple-domains-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-domains" title="Permalink"></a></h3><p>Figure 1 shows an example of a mesh, containing both  <code>Quadrilateral</code> and <code>Triangle</code> elements, as well as two different materials, which we call &quot;matrix&quot; and &quot;conclusion&quot;. In this case, we could have two <code>SubDofHandlers</code>, one for triangles and one for quadrilateral. If we would like to assemble the cell contribution for this grid, we need four different domains,  shown by the different colors in the figure.  This is because the the <code>CellBuffer</code> would contain different <code>material</code> types for each domain, and we would require different <code>CellValues</code> for the triangles and quadrilaterals. </p><p><img src="../assets/domains.svg" alt="domains"/></p><p>Figure 1: Domains</p><p>When setting up the domains, we collect all domains into a <code>Dict</code>, which is  done by calling <code>setup_domainbuffers(::Dict{String,DomainSpec}; kwargs...)</code>, where the keyword arguments are the same as for a single domainbuffer. </p><h3 id="User-defined-overloaded-functions"><a class="docs-heading-anchor" href="#User-defined-overloaded-functions">User-defined overloaded functions</a><a id="User-defined-overloaded-functions-1"></a><a class="docs-heading-anchor-permalink" href="#User-defined-overloaded-functions" title="Permalink"></a></h3><p>The user interacts with <code>FerriteAssembly</code> on the top level, when setting up the domain buffer and the worker. But to make it work, the user must also overload  several functions that happen at the innermost part of the iteration of items in the grid. Some key functions to be overloaded are </p><ul><li><code>element_routine!</code>: Calculate <code>Ke</code>, <code>re</code>, and <code>state</code></li><li><code>element_residual!</code>: Calculate <code>re</code>, and <code>state</code></li><li><code>create_cell_state</code>: For the given material and initial cell dof values, return the initial value of the cell state. Typically one value per integration point. </li><li><code>allocate_cell_cache</code>: Define workspace for calculation on a single cell</li><li><code>allocate_facet_cache</code>: Same as above, but for a facet </li></ul><h3 id="State-variables"><a class="docs-heading-anchor" href="#State-variables">State variables</a><a id="State-variables-1"></a><a class="docs-heading-anchor-permalink" href="#State-variables" title="Permalink"></a></h3><p>State variables (both current and old) are stored as a <code>Dict{Int}</code> in the domain buffer (for cells, not for facets, this may be added in the future).  The key corresponds to the cell id, and the state can be gotten with the  <code>get_state</code> and <code>get_old_state</code> functions. </p><h3 id="User-data"><a class="docs-heading-anchor" href="#User-data">User-data</a><a id="User-data-1"></a><a class="docs-heading-anchor-permalink" href="#User-data" title="Permalink"></a></h3><p>All item buffers contain a <code>user_data</code> field for passing any additional information to the item being worked. In most cases, this should not be necessary, but it provides an easy way to do something that is not normally supported.  The object is passed around as reference; care must thus be taken to avoid race conditions if written to during threaded work.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../howto/surface_integral/">« Surface integration</a><a class="docs-footer-nextpage" href="../DomainBuffers/Setup/">DomainBuffers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.1 on <span class="colophon-date" title="Saturday 19 April 2025 20:32">Saturday 19 April 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
